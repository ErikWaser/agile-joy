<!--
    this code is partly based on examples from https://observablehq.com/@d3
    map data source based on: Öppna data, Lantmäteriet
    covid data source: - https://github.com/codler/sweden-coronavirus
                       - Folkhälsomyndigheten
-->

<html lang="en">
    <head>
        <script src="js/d3.v7.min.js"></script>
        <style>
            body {margin: 10px; background: #444; font: 1.2em sans-serif}
            svg {background: #444}
            .lan {letter-spacing:-0.06em; font-size:1.5em; font-weight:bold;
                float:left; width:100%}
            .datum {font-size:0.9em; font-weight:lighter; float:left}
            .data_div {width: 20em; height: 30em; margin: -20em 0 0 20em;
                       color: #fff}
            /* .map path {stroke: #000; stroke-width: 1px} */
        </style>
    </head>
<body>

<svg width="320px" height="500px">
    <g class="map"></g>
</svg>

<div class="data_div"></div>

<select name="Välj åldersgrupp" id="ageselect">
    <option value="">Välj åldersgrupp</option>
    <option value="18-19 år">18-19 år</option>
    <option value="20-24 år">20-24 år</option>
    <option value="25-29 år">25-29 år</option>
    <option value="30-34 år">30-34 år</option>
    <option value="35-39 år">35-39 år</option>
    <option value="40-44 år">40-44 år</option>
    <option value="45-49 år">45-49 år</option>
    <option value="50-54 år">50-54 år</option>
    <option value="55-59 år">55-59 år</option>
    <option value="60-64 år">60-64 år</option>
    <option value="65-69 år">65-69 år</option>
    <option value="70-74 år">70-74 år</option>
    <option value="75-79 år">75-79 år</option>
    <option value="80-84 år">80-84 år</option>
    <option value="85-89 år">85-89 år</option>
    <option value="90-94 år">90-94 år</option>
    <option value="95-99 år">95-99 år</option>
    <option value="100+ år">100+ år</option>

  </select>

<script>

    let geojson;
    let covid_data = {};
    let proj;
    let d_format = d3.timeFormat("%d %B %Y");
    let d_parse = d3.timeParse("%m-%d-%y");
    let geoGenerator = d3.geoPath().projection(proj);
    let agespan;
    let minmax;

    var tmp_colour;

    let t = d3.transition()
        .duration(1000)
        .ease(d3.easeLinear);

    let state = {
        type:       'Mercator',
        scale:      900,
        translateX: 170,
        translateY: 250,
        centerLon:  15,
        centerLat:  63
    }

    function find_min_max(obj, offset){
        var min = Number.POSITIVE_INFINITY;
        var max = Number.NEGATIVE_INFINITY;
        console.log(obj);
        for(const i in obj){
            var county = i;
            var cnt=0;
            for(const j in obj[i]) {
                if (cnt > offset) {
                    var ages = j;
                    var tmp = obj[county][ages];
                    console.log(tmp);

                    if (tmp < min) {
                        min = tmp;
                        console.log("New min");
                        console.log(county, ages);
                    }
                    if (tmp > max) {
                        console.log("New max");
                        console.log(county, ages);
                        max = tmp;
                    }
                }
                cnt++;
            }
        }
       return[min,max];
    }

    function heat_colour([min,max]){
            return d3.scaleSequential([min,max],d3.interpolateReds);
        }

    function handle_mouseover(a, geojson_data) {

        let lan_name = geojson_data.properties.LnNamn;
        let lan_kod = geojson_data.properties.LnKod;
        let lan_cases = covid_data[lan_name][agespan];
        console.log(agespan);
        d3.select(".data_div")
            .html(
                  "<div class=\"lan\">" + lan_name + " </div>" +
                  "<br/>" +
                  "Sjukdomsfall: " + lan_cases +
                  "<br/>"
                 )

        var this_path = d3.select(this);
        tmp_colour = this_path.attr("fill");
        this_path.attr("fill", "#f00")
    }

    function handle_mouseout() {
        d3.select(this).attr("fill", tmp_colour)
    }

    function clickable() {
        d3.selectAll("path").on("mouseover", handle_mouseover);
        d3.selectAll("path").on("mouseout", handle_mouseout);
    }

    function update() {

        proj = d3.geoMercator()
        geoGenerator.projection(proj)

        proj.scale(state.scale)
            .translate([state.translateX, state.translateY])
            .center([state.centerLon, state.centerLat])

        let u = d3.select('g.map')
            .selectAll('path')
            .data(geojson.features)

        let minmax = find_min_max(covid_data,0);
        console.log(minmax);
        u.enter()
           .append('path')
           .attr("fill", "#eee")
           .attr("fill", d =>
                 heat_colour(minmax)(covid_data[d.properties.LnNamn][agespan]))
// for debugging: .attr("fake", d=> console.log(d.properties.LnNamn))
           .attr('d', geoGenerator)
    }

    /* adjust CSV data to correspond to codes
       in GeoJSON file data/lan_7.0.geojson: */
    path = 'data/agedata.csv';

    // function loadData(agespan) {


    //     d3.dsv(';', path).then(function(data) {
    //     for (let i = 0; i < data.length; i++) {
    //         covid_data[data[i].län] = data[i][agespan];
    //     }
    //     //covid_data['18-19 år'] = temp;
    //     //console.log(covid_data);
    //     //console.log(covid_data['18-19 år']['Stockholms län']);
        
    // });
    // }
    // loadData("20-24 år");

    d3.dsv(';', path).then(function(data) {
        for (let i = 0; i < data.length; i++) {
            covid_data[data[i].län] = data[i]; 
        }
    });

    d3.json('data/lan_7.0.geojson')
        .then(d => { geojson = d })
        .then(update)
        .then(clickable)

    const selectElement = document.getElementById('ageselect')

    selectElement.addEventListener('change', (event) => {
        agespan = event.target.value;
        console.log(agespan)
        update();
        });

</script>
</body>
</html>
